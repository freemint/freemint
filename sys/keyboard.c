/* Keyboard handling stuff
 *
 * This file belongs to FreeMiNT.  It's not in the original MiNT 1.12
 * distribution.
 *
 * This file is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2, or (at your option)
 * any later version.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 *
 * Author: Konrad M. Kokoszkiewicz <draco@atari.org>
 *
 */

# include "mint/mint.h"
# include "mint/signal.h"	/* SIGQUIT */

# include "bios.h"		/* kbshft, kintr, ...  */
# include "biosfs.h"		/* struct tty */
# include "debug.h"		/* do_func_key() */
# include "dev-mouse.h"		/* mshift */
# include "dos.h"		/* s_hutdown() */
# include "init.h"		/* boot_printf() */
# include "k_fds.h"		/* fp_alloc() */
# include "kmemory.h"		/* kmalloc() */
# include "proc.h"		/* rootproc */
# include "random.h"		/* add_keyboard_randomness() */
# include "signal.h"		/* killgroup() */
# include "timeout.h"		/* addroottimeout() */

# include <osbind.h>

/* modifier masks for the kbshift() */
# define MM_RSHIFT	0x01
# define MM_LSHIFT	0x02
# define MM_CTRL	0x04
# define MM_ALTERNATE	0x08
# define MM_CAPS	0x10
# define MM_CLRHOME	0x20
# define MM_INSERT	0x40

/* masks for key combinations */
# define MM_ESHIFT	0x03	/* either shift */
# define MM_CTRLALT	0x0c

/* some key definitions */
# define CONTROL	0x1d	/* scan code for control key */
# define LSHIFT		0x2a	/* scan code for left shift */
# define RSHIFT		0x36	/* scan code for right shift */
# define ALTERNATE	0x38	/* scan code for alternate key */
# define CAPS		0x3a	/* scan code of caps lock key */
# define CLRHOME	0x47	/* scan code for clr/home key */
# define INSERT		0x52	/* scan code for insert key */
# define DEL		0x53	/* scan code of delete key */
# define UNDO		0x61	/* scan code of undo key */
# define HELP		0x62	/* scan code of help key */

# define MAXAKP		8	/* maximum _AKP code supported */

/* Functions exported */
short ikbd_scan(ushort scancode);
void load_keytbl(void);

/* Keyboard definition tables (taken off TOS 4.04, with fixes) */

/* USA, _AKP code 0 */

/* Unshifted */

static const char usa_kbd[] =
{
	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'-' ,'=' ,0x08,0x09,
	'q' ,'w' ,'e' ,'r' ,'t' ,'y' ,'u' ,'i' ,
	'o' ,'p' ,'[' ,']' ,0x0d,0x00,'a' ,'s' ,
	'd' ,'f' ,'g' ,'h' ,'j' ,'k' ,'l' ,';' ,
	'\'','`' ,0x00,'\\','z' ,'x' ,'c' ,'v' ,
	'b' ,'n' ,'m' ,',' ,'.' ,'/' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Shifted */

	0x00,0x1b,'!' ,'@' ,'#' ,'$' ,'%' ,'^' ,
	'&' ,'*' ,'(' ,')' ,'_' ,'+' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,'{' ,'}' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,':' ,
	'"' ,'~' ,0x00,'|' ,'Z' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,'<' ,'>' ,'?' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,'7' ,
	'8' ,0x00,'-' ,'4' ,0x00,'6' ,'+' ,0x00,
	'2' ,0x00,'0' ,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Caps */

	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'-' ,'=' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,'[' ,']' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,';' ,
	'\'','`' ,0x00,'\\','Z' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,',' ,'.' ,'/' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Alternate */
	0x00,

/* Alternate shifted */
	0x00,

/* Alternate Caps */
	0x00
};

/* German, (1) */

/* Unshifted */

static const char german_kbd[] =
{
	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,0x9e,'\'',0x08,0x09,
	'q' ,'w' ,'e' ,'r' ,'t' ,'z' ,'u' ,'i' ,
	'o' ,'p' ,0x81,'+' ,0x0d,0x00,'a' ,'s' ,
	'd' ,'f' ,'g' ,'h' ,'j' ,'k' ,'l' ,0x94,
	0x84,'#' ,0x00,'~' ,'y' ,'x' ,'c' ,'v' ,
	'b' ,'n' ,'m' ,',' ,'.' ,'-' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Shifted */

	0x00,0x1b,'!' ,'"' ,0xdd,'$' ,'%' ,'&' ,
	'/' ,'(' ,')' ,'=' ,'?' ,'`' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Z' ,'U' ,'I' ,
	'O' ,'P' ,0x9a,'*' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0x99,
	0x8e,'^' ,0x00,'|' ,'Y' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,';' ,':' ,'_' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,'7' ,
	'8' ,0x00,'-' ,'4' ,0x00,'6' ,'+' ,0x00,
	'2' ,0x00,'0' ,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'>' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Caps */

	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,0x9e,'\'',0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Z' ,'U' ,'I' ,
	'O' ,'P' ,0x9a,'+' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0x99,
	0x8e,'#' ,0x00,'~' ,'Y' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,',' ,'.' ,'-' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Alternate */

	0x1a,'@' ,'\'','[' ,'(' ,']' ,0x00,

/* Alternate shifted */

	0x1a,'\\','\'','{' ,'(' ,'}' ,0x00,

/* Alternate Caps */

	0x1a,'@' ,'\'','[' ,'(' ,']' ,0x00
};

/* French (2) */

/* Unshifted */

static const char french_kbd[] =
{
	0x00,0x1b,'&' ,0x82,'"' ,'\'','(' ,0xdd,
	0x8a,'!' ,0x87,0x85,')' ,'-' ,0x08,0x09,
	'a' ,'z' ,'e' ,'r' ,'t' ,'y' ,'u' ,'i' ,
	'o' ,'p' ,'^' ,'$' ,0x0d,0x00,'q' ,'s' ,
	'd' ,'f' ,'g' ,'h' ,'j' ,'k' ,'l' ,'m' ,
	0x97,'`' ,0x00,'#' ,'w' ,'x' ,'c' ,'v' ,
	'b' ,'n' ,',' ,';' ,':' ,'=' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Shifted */

	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,0xf8,'_' ,0x08,0x09,
	'A' ,'Z' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,0xb9,'*' ,0x0d,0x00,'Q' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,'M' ,
	'%' ,0x9c,0x00,'|' ,'W' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'?' ,'.' ,'/' ,'+' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,'7' ,
	'8' ,0x00,'-' ,'4' ,0x00,'6' ,'+' ,0x00,
	'2' ,0x00,'0' ,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'>' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Caps */

	0x00,0x1b,'&' ,0x90,'"' ,'\'','(' ,0xdd,
	0x8a,'!' ,0x80,0xb6,')' ,'-' ,0x08,0x09,
	'A' ,'Z' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,'^' ,'$' ,0x0d,0x00,'Q' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,'M' ,
	0x97,'`' ,0x00,'#' ,'W' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,',' ,';' ,':' ,'=' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Alternate */

	0x1a,'[' ,0x1b,']' ,'(' ,'\\','+' ,'@' ,0x00,

/* Alternate shifted */

	0x1a,'{' ,0x1b,'}' ,'(' ,0x00,

/* Alternate Caps */

	0x1a,'[' ,0x1b,']' ,'(' ,'\\','+' ,'@' ,0x00
};

/* British (3) */

/* Unshifted */

static const char british_kbd[] =
{
	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'-' ,'=' ,0x08,0x09,
	'q' ,'w' ,'e' ,'r' ,'t' ,'y' ,'u' ,'i' ,
	'o' ,'p' ,'[' ,']' ,0x0d,0x00,'a' ,'s' ,
	'd' ,'f' ,'g' ,'h' ,'j' ,'k' ,'l' ,';' ,
	'\'','`' ,0x00,'#' ,'z' ,'x' ,'c' ,'v' ,
	'b' ,'n' ,'m' ,',' ,'.' ,'/' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'\\',0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Shifted */

	0x00,0x1b,'!' ,'"' ,0x9c,'$' ,'%' ,'^' ,
	'&' ,'*' ,'(' ,')' ,'_' ,'+' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,'{' ,'}' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,':' ,
	'@' ,0xff,0x00,'~' ,'Z' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,'<' ,'>' ,'?' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,'7' ,
	'8' ,0x00,'-' ,'4' ,0x00,'6' ,'+' ,0x00,
	'2' ,0x00,'0' ,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'|' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Caps */

	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'-' ,'=' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,'[' ,']' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,';' ,
	'\'','`' ,0x00,'#' ,'Z' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,',' ,'.' ,'/' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'\\',0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Alternate */
	0x00,

/* Alternate shifted */
	0x00,

/* Alternate Caps */
	0x00
};

/* Spanish (4) */

/* Unshifted */

static const char spanish_kbd[] =
{
	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'-' ,'=' ,0x08,0x09,
	'q' ,'w' ,'e' ,'r' ,'t' ,'y' ,'u' ,'i' ,
	'o' ,'p' ,'\'','`' ,0x0d,0x00,'a' ,'s' ,
	'd' ,'f' ,'g' ,'h' ,'j' ,'k' ,'l' ,0xa4,
	';' ,0x87,0x00,'\\','z' ,'x' ,'c' ,'v' ,
	'b' ,'n' ,'m' ,',' ,'.' ,0xf8,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Shifted */

	0x00,0x1b,0xad,0xa8,0x9c,'$' ,'%' ,'/' ,
	'&' ,'*' ,'(' ,')' ,'_' ,'+' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,'"' ,'^' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0xa5,
	':' ,'~' ,0x00,'|' ,'Z' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,'?' ,'!' ,0xdd,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,'7' ,
	'8' ,0x00,'-' ,'4' ,0x00,'6' ,'+' ,0x00,
	'2' ,0x00,'0' ,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'>' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Caps */

	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'-' ,'=' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,'\'','`' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0xa5,
	';' ,0x87,0x00,'\\','Z' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,',' ,'.' ,0xf8,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Alternate */

	0x1a,'[' ,0x1b,']' ,'+' ,'#' ,'(' ,0x81,
	'\'',0x00,

/* Alternate shifted */

	0x1a,'{' ,0x1b,'}' ,'+' ,'@' ,'(' ,0x00,

/* Alternate Caps */

	0x1a,'[' ,0x1b,']' ,'+' ,'#' ,'(' ,0x81,
	'\'',0x00
};

/* Italian (5) */

/* Unshifted */

static const char italian_kbd[] =
{
	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'\'',0x8d,0x08,0x09,
	'q' ,'w' ,'e' ,'r' ,'t' ,'y' ,'u' ,'i' ,
	'o' ,'p' ,0x8a,'+' ,0x0d,0x00,'a' ,'s' ,
	'd' ,'f' ,'g' ,'h' ,'j' ,'k' ,'l' ,0x95,
	0x85,0x97,0x00,'\\','z' ,'x' ,'c' ,'v' ,
	'b' ,'n' ,'m' ,',' ,'.' ,'-' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Shifted */

	0x00,0x1b,'!' ,'"' ,0x9c,'$' ,'%' ,'&' ,
	'/' ,'(' ,')' ,'=' ,'?' ,'^' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,0x82,'*' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,'@' ,
	'#' ,0xdd,0x00,'|' ,'Z' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,';' ,':' ,'_' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,'7' ,
	'8' ,0x00,'-' ,'4' ,0x00,'6' ,'+' ,0x00,
	'2' ,0x00,'0' ,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'>' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Caps */

	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'\'',0x8d,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Y' ,'U' ,'I' ,
	'O' ,'P' ,0x8a,'+' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0x95,
	0x85,0x97,0x00,'\\','Z' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,',' ,'.' ,'-' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Alternate */

	0x1a,'[' ,0x1b,']' ,'+' ,0xf8,'`' ,'`' ,0x00,

/* Alternate shifted */

	0x1a,'{' ,0x1b,'}' ,'+' ,'~' ,'`' ,'`' ,0x00,

/* Alternate Caps */

	0x1a,'[' ,0x1b,']' ,'+' ,0xf8,'`' ,'`' ,0x00
};

/* Swiss French (7) */

/* Unshifted */

static const char sw_french_kbd[] =
{
	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'\'','^' ,0x08,0x09,
	'q' ,'w' ,'e' ,'r' ,'t' ,'z' ,'u' ,'i' ,
	'o' ,'p' ,0x8a,0xb9,0x0d,0x00,'a' ,'s' ,
	'd' ,'f' ,'g' ,'h' ,'j' ,'k' ,'l' ,0x82,
	0x85,0xdd,0x00,'$' ,'y' ,'x' ,'c' ,'v' ,
	'b' ,'n' ,'m' ,',' ,'.' ,'-' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Shifted */

	0x00,0x1b,'+' ,'"' ,'*' ,0x87,'%' ,'&' ,
	'/' ,'(' ,')' ,'=' ,'?' ,'`' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Z' ,'U' ,'I' ,
	'O' ,'P' ,0x81,'!' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0x94,
	0x84,0xf8,0x00,0x9c,'Y' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,';' ,':' ,'_' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,'7' ,
	'8' ,0x00,'-' ,'4' ,0x00,'6' ,'+' ,0x00,
	'2' ,0x00,'0' ,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'>' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Caps */

	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'\'','^' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Z' ,'U' ,'I' ,
	'O' ,'P' ,0x8a,0xb9,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0x82,
	0x85,0xdd,0x00,'$' ,'Y' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,',' ,'.' ,'-' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Alternate */

	0x1a,'@' ,'\'','[' ,'(' ,']' ,0x1b,'#' ,
	'+' ,'~' ,0x00,

/* Alternate shifted */

	0x1a,'\\','\'','{' ,'(' ,'}' ,0x1b,'#' ,
	'+' ,'|' ,0x00,

/* Alternate Caps */

	0x1a,'@' ,'\'','[' ,'(' ,']' ,0x1b,'#' ,
	'+' ,'~' ,0x00
};

/* Swiss German (8) */

/* Unshifted */

static const char sw_german_kbd[] =
{
	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'\'','^' ,0x08,0x09,
	'q' ,'w' ,'e' ,'r' ,'t' ,'z' ,'u' ,'i' ,
	'o' ,'p' ,0x81,0xb9,0x0d,0x00,'a' ,'s' ,
	'd' ,'f' ,'g' ,'h' ,'j' ,'k' ,'l' ,0x94,
	0x84,0xdd,0x00,'$' ,'y' ,'x' ,'c' ,'v' ,
	'b' ,'n' ,'m' ,',' ,'.' ,'-' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Shifted */

	0x00,0x1b,'+' ,'"' ,'*' ,0x87,'%' ,'&' ,
	'/' ,'(' ,')' ,'=' ,'?' ,'`' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Z' ,'U' ,'I' ,
	'O' ,'P' ,0x8a,'!' ,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0x82,
	0x85,0xf8,0x00,0x9c,'Y' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,';' ,':' ,'_' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,'7' ,
	'8' ,0x00,'-' ,'4' ,0x00,'6' ,'+' ,0x00,
	'2' ,0x00,'0' ,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'>' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Caps */

	0x00,0x1b,'1' ,'2' ,'3' ,'4' ,'5' ,'6' ,
	'7' ,'8' ,'9' ,'0' ,'\'','^' ,0x08,0x09,
	'Q' ,'W' ,'E' ,'R' ,'T' ,'Z' ,'U' ,'I' ,
	'O' ,'P' ,0x9a,0xb9,0x0d,0x00,'A' ,'S' ,
	'D' ,'F' ,'G' ,'H' ,'J' ,'K' ,'L' ,0x99,
	0x8e,0xdd,0x00,'$' ,'Y' ,'X' ,'C' ,'V' ,
	'B' ,'N' ,'M' ,',' ,'.' ,'-' ,0x00,0x00,
	0x00,' ' ,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,'-' ,0x00,0x00,0x00,'+' ,0x00,
	0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	'<' ,0x00,0x00,'(' ,')' ,'/' ,'*' ,'7' ,
	'8' ,'9' ,'4' ,'5' ,'6' ,'1' ,'2' ,'3' ,
	'0' ,'.' ,0x0d,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/* Alternate */

	0x1a,'@' ,'\'','[' ,'(' ,']' ,0x1b,'#' ,
	'+' ,'~' ,0x00,

/* Alternate shifted */

	0x1a,'\\','\'','{' ,'(' ,'}' ,0x1b,'#' ,
	'+' ,'|' ,0x00,

/* Alternate Caps */

	0x1a,'@' ,'\'','[' ,'(' ,']' ,0x1b,'#' ,
	'+' ,'~' ,0x00
};

/* Keyboard interrupt routine.
 *
 * TOS goes through here with the freshly baked and still
 * warm key scancode in hands. If there are any keys or
 * key combinations we want to handle (e.g. Ctrl/Alt/Del)
 * then we intercept it now.
 *
 * At the end, you need to return the original scancode for
 * TOS to process it. If you change the value, TOS will buy
 * this as well. If you want to omit the TOS routines at all,
 * return -1 (see code in intr.spp).
 *
 * Developing this code will probably allow us to get rid of
 * checkkeys() in bios.c, have processes waiting for keyboard
 * awaken immediately, load own scancode->ASCII keyboard tables
 * and do other such nifty things (draco).
 *
 */

/* Define the routine producing the keyclick
 */
typedef void (*KEYCLK)(void);

static	short cad_lock;	/* semaphore to avoid scheduling shutdown() twice */
short 	gl_kbd;		/* keyboard layout, set by getmch() in init.c */

const char *keyboards[] =
{
	usa_kbd, german_kbd, french_kbd, british_kbd, spanish_kbd,
	italian_kbd, british_kbd, sw_french_kbd, sw_german_kbd,
	0
};

/* Routine called after the user hit Ctrl/Alt/Del
 */
static void
ctrl_alt_del(PROC *p, long arg)
{
	s_hutdown(arg);
}

/* The handler
 */
short
ikbd_scan(ushort scancode)
{
	ushort mod = 0, clk = 0, shift = *kbshft;

	scancode &= 0x00ff;		/* better safe than sorry */

# ifdef DEV_RANDOM
	add_keyboard_randomness((ushort)((scancode << 8) | shift));
# endif

	/* We handle modifiers first
	 */
	switch(scancode)
	{
		case	CONTROL:
		{
			shift |= MM_CTRL;
			mod++;
			break;
		}
		case	LSHIFT:
		{
			shift |= MM_LSHIFT;
			mod++;
			break;
		}
		case	RSHIFT:
		{
			shift |= MM_RSHIFT;
			mod++;
			break;
		}
		case	ALTERNATE:
		{
			shift |= MM_ALTERNATE;
			mod++;
			break;
		}
		case	CAPS:		/* Caps acts differently */
		{
			shift ^= MM_CAPS;
			mod++;
			clk++;
			break;
		}
		case	CLRHOME:
		{
			shift |= MM_CLRHOME;
			mod++;
			break;
		}
		case	INSERT:
		{
			shift |= MM_INSERT;
			mod++;
			break;
		}
		case	CONTROL+0x80:
		{
			shift &= ~MM_CTRL;
			mod++;
			break;
		}
		case	LSHIFT+0x80:
		{
			shift &= ~MM_LSHIFT;
			mod++;
			break;
		}
		case	RSHIFT+0x80:
		{
			shift &= ~MM_RSHIFT;
			mod++;
			break;
		}
		case	ALTERNATE+0x80:
		{
			shift &= ~MM_ALTERNATE;
			mod++;
			break;
		}
		case	CLRHOME+0x80:
		{
			shift &= ~MM_CLRHOME;
			mod++;
			break;
		}
		case	INSERT+0x80:
		{
			shift &= ~MM_INSERT;
			mod++;
			break;
		}
	}
	if (mod)
	{
		ushort sc = scancode;

		*kbshft = mshift = (char)shift;
		if (clk)
			(*(KEYCLK *)0x05b0L)();		/* produce keyclick */
		sc &= 0x7f;
		if ((sc != CLRHOME) && (sc != INSERT))
			return -1;
	}

	/* Here we handle keys of `system wide' meaning. These are:
	 *
	 * Ctrl/Alt/Del		-> warm start
	 * Ctrl/Alt/RShift/Del	-> cold start
	 * Ctrl/Alt/LShift/Del	-> halt
	 * Ctrl/Alt/Undo	-> SIGQUIT to the group
	 * Ctrl/Alt/Fx		-> debug information
	 * Ctrl/Alt/Shift/Fx	-> debug information
	 *
	 */
	if ((shift & MM_CTRLALT) == MM_CTRLALT)
	{
		if (scancode == DEL)
		{
			if (!cad_lock)
			{
				TIMEOUT *t;

				t = addroottimeout(0L, (void _cdecl (*)(PROC *))ctrl_alt_del, 1);
				if (t)
				{
					t->arg = 1;
					if ((shift & MM_ESHIFT) == MM_RSHIFT)
						t->arg++;
					else if ((shift & MM_ESHIFT) == MM_LSHIFT)
						t->arg--;
					cad_lock++;
				}
			}
			goto key_handled;
		}
		else if (scancode == UNDO)
		{
			killgroup(con_tty.pgrp, SIGQUIT, 1);
			goto key_handled;
		}
		else if ((scancode >= 0x003b) && (scancode <= 0x0044))
		{
			if (shift & MM_ESHIFT)
				scancode += 0x0019;	/* emulate F11-F20 */
			do_func_key(scancode);
			goto key_handled;
		}
		/* This is in case the keyboard has real F11-F20 keys on it */
		else if ((scancode >= 0x0054) && (scancode <= 0x005d))
		{
			do_func_key(scancode);
			goto key_handled;
		}
	}

	/* Add Alt/Help here ... block it for now, until a better idea.
	 * What about firing up the /c/multitos/althelp.sys ?
	 */
	if ((shift & MM_ALTERNATE) == MM_ALTERNATE)
	{
		if (scancode == HELP)
			goto key_handled;
	}

	/* Ordinary keyboard add here ...
	 */

	kintr = 1;

	return scancode;	/* for now, give the scancode away to TOS */

key_handled:
	(*(KEYCLK *)0x05b0L)();		/* produce keyclick */
	return -1;
}

static void
load_table(FILEPTR *fp, char *name, long size)
{
	char *kbuf;

	/* This is 128+128+128 for unshifted, shifted and caps
	 * tables respectively; plus 3 bytes for three alt ones,
	 * plus two bytes magic header, gives 389 bytes minimum.
	 */
	if (size < 389L) return;

	kbuf = kmalloc(size);
	if (!kbuf) return;

	if ((*fp->dev->read)(fp, kbuf, size) != size)
	{
		kfree(kbuf);
		return;
	}
	if (*(short *)kbuf != 0x2771)	/* magic word */
	{
		kfree(kbuf);
		return;
	}

	/* Success */
	gl_kbd = 6;
	keyboards[6] = kbuf + sizeof(short);

	boot_printf("Loaded keyboard table %s\r\n", name);
}

void
load_keytbl(void)
{
	XATTR xattr;
	FILEPTR *fp;
	long ret;
	char *name;

	ret = fp_alloc(rootproc, &fp);
	if (ret) return;

	/* `keybd.tbl' is already used by GEM.SYS, we can't conflict
	 */
	name = "\\keybd.sys";
	ret = do_open(&fp, name, O_RDONLY, 0, &xattr);
	if (ret)
	{
		name = "\\multitos\\keybd.sys";
		ret = do_open(&fp, name, O_RDONLY, 0, &xattr);
	}
	if (ret)
	{
		name = "\\mint\\keybd.sys";
		ret = do_open(&fp, name, O_RDONLY, 0, &xattr);
	}
	if (!ret)
	{
		load_table(fp, name, xattr.size);
		do_close(rootproc, fp);
	}
}

/* EOF */
